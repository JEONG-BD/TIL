# 전송계층

## 혼잡 제어(congestion control)
- 같은 네트워크에 속한 여러 호스트가 한 대의 라우터에 연결되어 있다고 가정했을 때 모든 호스트가 라우터에게 전송 가능한 최대 양을 전송하면 라우터에 과부하가 생겨 모든 정보를 한 번에 처리가 불가능하며 호스트들은 오류를 검출하여 재전송 하게 되고 라우터에 혼잡 현상은 더욱 악화된다. 
- TCP 혼잡제어는 위와 같은 상황을 제어하기 위한 기능이다. 
- **흐름제어의 주체가 수신 호스트라면 혼잡 제어의 주체는 송신 호스트이다.**
- 혼잡 제어를 수행하는 송신 호스트는 네트워크 혼잡도를 판단 후 유동적으로 전송량을 조절한다. 

### 혼잡 윈도우(congestion window)
- 혼잡 없이 전송할 수 있을 법한 데이터의 양을 의미한다. 
- 세그먼트를 송신하는 호스트의 입장에서는 수신 윈도우의 크기는 수신 호스트가 TCP 헤더로 알려주기 때문에 별도의 고민이 필요없지만 혼잡 윈도우의 크기는 송신 호스트가 어느 정도의 세그먼트를 전송해야 혼잡을 방지할 수 있는지 직접 계산해야 한다. 
- 혼잡 윈도우의 적당한 크기는 혼잡 제어 알고리즘을 통해서 결정할 수 있다. 

### 혼잡 윈도우와 혼잡 제어 알고리즘 
#### AIMD(Additive Increase/Multiplicative Decrease) 
- 혼잡이 감지되지 않으면 혼자 윈도우를 RTT 마다 1씩 선형적으로 증가시키고 혼잡이 감지되면 혼잡 윈도우를 절반씩 떨어뜨리는 동작을 반복하는 알고리즘이다. 

#### 느린시작 알고리즘(Slow start)
- 혼잡 윈도우를 1부터 시작해 문제없이 수신된 ACK세그먼트 하나당 1씩 증가하는 방법이다.
- 혼잡 윈도우는 RTT마다 2배씩 지수적으로 증가하게 된다. 
- AIMD는 처음 연결 수립 후 혼잡 윈도우의 크기가 증가하는 속도가 느리지만 선형적으로 혼잡 윈도우의 크기를 증가시키므로 초기 전송 속도가 확보 되지 않지만 느린시작을 이용하면 혼잡 윈도우의 지수적인 증가를 활용해서 초기 전송 속도를 어느 정도 빠르게 확보할 수 있다. 

#### 느린 시작 임계치(Slow start threshold)
- 혼잡 윈도우를 언제까지 지수적으로 증가할 수 없다. 언젠가 혼잡 상황을 마주할 확률이 높기 때문이다. 
- 느린 시작 알고리즘을 사용할 때 함께 사용하는 값으로 느린 시작 임계치라는 값이 정해져 있다. 
- 혼잡 윈도우 값이 계속 증가하다가 느린 시작 임계치 이상이 되거나 타임아웃이 발생하거나, 세번의 중복된 ACK 세그먼트가 발생하여 혼잡이 감지되면 각각의 값을 선택하게 된다.
  

| 상황| 혼잡 윈도우(`cwnd`) 변화| 임계치(`ssthresh`) 변화| 결과 상태|
|---|---|---|---|
| ssthresh 도달 (느린 시작 종료) | `cwnd += 1` (선형 증가, AIMD 방식)| 변하지 않음| 혼잡 회피 수행 (Congestion Avoidance)|
| 타임아웃 발생 | `cwnd = 1` (초기화)                   | `ssthresh = cwnd / 2` *(타임아웃 직전 값 기준)*     | 느린 시작 (Slow Start) 재개|
| 중복 ACK 3번 수신             | `cwnd = ssthresh` (빠르게 재전송)       | `ssthresh = cwnd / 2` *(중복 ACK 수신 시점 기준)*   | 빠른 회복 (Fast Recovery) 진입 후 혼잡 회피 |


#### 혼잡 회피 알고리즘(congestion avoidance) 
- 혼잡 회피 알고리즘은 RTT 마다 혼잡 윈도우를 1MSS 씩 증가하는 알고리즘이다. 
- 혼잡 회피 중 타임 아웃이 발생하면 혼잡 윈도우의 값을 1로 느린 시작 임계치는 혼잡이 감지된 시점의 혼잡 윈도우 값의 절반으로 초기화한뒤 다시 느린 시작을 수행한다. 

#### 빠른 회복(fast recovery) 알고리즘 
- 세번의 중복된 ACK 세그먼트를 수신하면 빠른 재전송과 더불어 빠름 회복 알고리즘이 수행된다. 
- 세번의 중복된 ACK 세그먼트를 수신했을 때 느린시작은 건너 뛰고 혼잡 회피를 수행하는 알고리즘으로 빠르게 전송률을 회복하기 위한 알고리즘이다. 


### 명시적 혼잡 알림(Explicit Congestion Notification) 
- 혼잡 제어 알고리즘에 따르면 혼잡 제어를 위해 어느 정도의 양을 송신할지 결정하는 것은 송신 호스트의 몫이었지만 최근 혼잡을 회피하기 위해 네트워크 중간 장치의 도움을 받는 것이 명시적 혼잡 알림이다. 
- ECN은 선택적인 기능이기 때문에 이를 지원하는 호스트가 있고 지원하지 않는 호스트가 있다. 
- ECN을 지원하는 호스트가 TCP/IP 프로토콜로 정보를 주고 받을 때 IP 헤더와 TCP 헤더에 ECN 관련 필드가 추가 된다. 
- IP 헤더에서는 서비스 필드 내에 두 비트가 ECN 으로 사용되고 TCP 헤더에서는 제어 비트의 CWR, ECE 비트가 ECN 비트로 사용된다. 

--- 
> 강민철, 『혼자 공부하는 네트워크』, 한빛미디어 (2018)    

